{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/lib/supabase/server.ts"],"sourcesContent":["/**\r\n * Supabase Server Client\r\n * Use this client in server components, API routes, and server actions\r\n */\r\n\r\nimport { createServerClient, type CookieOptions } from '@supabase/ssr'\r\nimport { cookies } from 'next/headers'\r\nimport type { Database } from './types'\r\n\r\nexport async function createClient() {\n  const cookieStore = await cookies()\n\r\n  return createServerClient<Database>(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get(name: string) {\r\n          return cookieStore.get(name)?.value\r\n        },\r\n        set(name: string, value: string, options: CookieOptions) {\r\n          try {\r\n            cookieStore.set({ name, value, ...options })\r\n          } catch (error) {\r\n            // Handle cookie errors (happens in Server Components)\r\n          }\r\n        },\r\n        remove(name: string, options: CookieOptions) {\r\n          try {\r\n            cookieStore.set({ name, value: '', ...options })\r\n          } catch (error) {\r\n            // Handle cookie errors\r\n          }\r\n        },\r\n      },\r\n    }\r\n  )\n}\n\n// Alias to match existing imports in API routes\nexport { createClient as createServerClient }\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;AAED;AAAA;AACA;;;AAGO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,sUAGvB;QACE,SAAS;YACP,KAAI,IAAY;gBACd,OAAO,YAAY,GAAG,CAAC,OAAO;YAChC;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAsB;gBACrD,IAAI;oBACF,YAAY,GAAG,CAAC;wBAAE;wBAAM;wBAAO,GAAG,OAAO;oBAAC;gBAC5C,EAAE,OAAO,OAAO;gBACd,sDAAsD;gBACxD;YACF;YACA,QAAO,IAAY,EAAE,OAAsB;gBACzC,IAAI;oBACF,YAAY,GAAG,CAAC;wBAAE;wBAAM,OAAO;wBAAI,GAAG,OAAO;oBAAC;gBAChD,EAAE,OAAO,OAAO;gBACd,uBAAuB;gBACzB;YACF;QACF;IACF;AAEJ","debugId":null}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/lib/supabase/index.ts/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const createBrowserClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call createBrowserClient() from the server but createBrowserClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/lib/supabase/index.ts <module evaluation>\",\n    \"createBrowserClient\",\n);\nexport const supabase = registerClientReference(\n    function() { throw new Error(\"Attempted to call supabase() from the server but supabase is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/lib/supabase/index.ts <module evaluation>\",\n    \"supabase\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,sBAAsB,IAAA,0QAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,2DACA;AAEG,MAAM,WAAW,IAAA,0QAAuB,EAC3C;IAAa,MAAM,IAAI,MAAM;AAAgO,GAC7P,2DACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 152, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/lib/supabase/index.ts/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const createBrowserClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call createBrowserClient() from the server but createBrowserClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/lib/supabase/index.ts\",\n    \"createBrowserClient\",\n);\nexport const supabase = registerClientReference(\n    function() { throw new Error(\"Attempted to call supabase() from the server but supabase is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/lib/supabase/index.ts\",\n    \"supabase\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;;;AACvE;;AACO,MAAM,sBAAsB,IAAA,0QAAuB,EACtD;IAAa,MAAM,IAAI,MAAM;AAAsP,GACnR,uCACA;AAEG,MAAM,WAAW,IAAA,0QAAuB,EAC3C;IAAa,MAAM,IAAI,MAAM;AAAgO,GAC7P,uCACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 171, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 179, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/services/database/auditLogService.ts"],"sourcesContent":["/**\r\n * Audit Log Service\r\n * Logs all credential-related events for compliance and debugging\r\n */\r\n\r\nimport { supabase } from '@/lib/supabase'\r\nimport type { Platform } from '@/types'\r\n\r\nexport interface AuditEventParams {\r\n  workspaceId: string\r\n  userId: string\r\n  platform: Platform\r\n  action: string\r\n  status: 'success' | 'failed' | 'partial'\r\n  errorMessage?: string\r\n  errorCode?: string\r\n  ipAddress?: string\r\n  userAgent?: string\r\n  requestPath?: string\r\n  metadata?: any\r\n}\r\n\r\n/**\r\n * Log an audit event\r\n */\r\nexport async function logAuditEvent({\r\n  workspaceId,\r\n  userId,\r\n  platform,\r\n  action,\r\n  status,\r\n  errorMessage,\r\n  errorCode,\r\n  ipAddress,\r\n  userAgent,\r\n  requestPath,\r\n  metadata,\r\n}: AuditEventParams): Promise<void> {\r\n  try {\r\n    const { error } = await supabase.from('credential_audit_log').insert({\r\n      workspace_id: workspaceId,\r\n      user_id: userId,\r\n      platform,\r\n      action,\r\n      status,\r\n      error_message: errorMessage || null,\r\n      error_code: errorCode || null,\r\n      ip_address: ipAddress || null,\r\n      user_agent: userAgent || null,\r\n      request_path: requestPath || null,\r\n      metadata: metadata || null,\r\n    } as any)\r\n\r\n    if (error) {\r\n      console.error('Failed to insert audit log:', error)\r\n    }\r\n  } catch (error) {\r\n    console.error('Audit logging error:', error)\r\n    // Don't throw - logging failures shouldn't break the app\r\n  }\r\n}\r\n\r\n/**\r\n * Get audit logs for a workspace\r\n */\r\nexport async function getAuditLogs(\r\n  workspaceId: string,\r\n  filters?: {\r\n    platform?: Platform\r\n    action?: string\r\n    status?: string\r\n    limit?: number\r\n    offset?: number\r\n    startDate?: Date\r\n    endDate?: Date\r\n  }\r\n): Promise<any[]> {\r\n  try {\r\n    let query = supabase\r\n      .from('credential_audit_log')\r\n      .select('*')\r\n      .eq('workspace_id', workspaceId)\r\n      .order('created_at', { ascending: false })\r\n\r\n    if (filters?.platform) {\r\n      query = query.eq('platform', filters.platform)\r\n    }\r\n\r\n    if (filters?.action) {\r\n      query = query.eq('action', filters.action)\r\n    }\r\n\r\n    if (filters?.status) {\r\n      query = query.eq('status', filters.status)\r\n    }\r\n\r\n    if (filters?.startDate) {\r\n      query = query.gte('created_at', filters.startDate.toISOString())\r\n    }\r\n\r\n    if (filters?.endDate) {\r\n      query = query.lte('created_at', filters.endDate.toISOString())\r\n    }\r\n\r\n    const limit = Math.min(filters?.limit || 100, 1000) // Cap at 1000\r\n    const offset = filters?.offset || 0\r\n\r\n    query = query.range(offset, offset + limit - 1)\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) throw error\r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Error fetching audit logs:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Get audit logs for a specific user\r\n */\r\nexport async function getUserAuditLogs(\r\n  workspaceId: string,\r\n  userId: string,\r\n  options?: {\r\n    limit?: number\r\n    offset?: number\r\n  }\r\n): Promise<any[]> {\r\n  try {\r\n    let query = supabase\r\n      .from('credential_audit_log')\r\n      .select('*')\r\n      .eq('workspace_id', workspaceId)\r\n      .eq('user_id', userId)\r\n      .order('created_at', { ascending: false })\r\n\r\n    const limit = Math.min(options?.limit || 50, 500)\r\n    const offset = options?.offset || 0\r\n\r\n    query = query.range(offset, offset + limit - 1)\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) throw error\r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Error fetching user audit logs:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Get summary of credential activities\r\n */\r\nexport async function getAuditSummary(\r\n  workspaceId: string,\r\n  days: number = 7\r\n): Promise<{\r\n  totalConnections: number\r\n  totalDisconnections: number\r\n  totalRefreshes: number\r\n  totalFailures: number\r\n  platformStats: Record<string, any>\r\n  recentActivity: any[]\r\n}> {\r\n  try {\r\n    const startDate = new Date()\r\n    startDate.setDate(startDate.getDate() - days)\r\n\r\n    const logs = await getAuditLogs(workspaceId, {\r\n      startDate,\r\n      limit: 1000,\r\n    })\r\n\r\n    const summary = {\r\n      totalConnections: 0,\r\n      totalDisconnections: 0,\r\n      totalRefreshes: 0,\r\n      totalFailures: 0,\r\n      platformStats: {\r\n        twitter: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        linkedin: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        facebook: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        instagram: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n      },\r\n      recentActivity: logs.slice(0, 10),\r\n    }\r\n\r\n    for (const log of logs) {\r\n      if (log.status === 'failed') {\r\n        summary.totalFailures++\r\n        ;(summary.platformStats as any)[(log as any).platform].failures++\r\n      }\r\n\r\n      if (log.action === 'platform_connected') {\r\n        summary.totalConnections++\r\n        ;(summary.platformStats as any)[(log as any).platform].connections++\r\n      } else if (log.action === 'platform_disconnected') {\r\n        summary.totalDisconnections++\r\n        ;(summary.platformStats as any)[(log as any).platform].disconnections++\r\n      } else if (log.action === 'token_refreshed') {\r\n        summary.totalRefreshes++\r\n        ;(summary.platformStats as any)[(log as any).platform].refreshes++\r\n      }\r\n    }\r\n\r\n    return summary\r\n  } catch (error) {\r\n    console.error('Error getting audit summary:', error)\r\n    return {\r\n      totalConnections: 0,\r\n      totalDisconnections: 0,\r\n      totalRefreshes: 0,\r\n      totalFailures: 0,\r\n      platformStats: {\r\n        twitter: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        linkedin: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        facebook: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n        instagram: { connections: 0, disconnections: 0, refreshes: 0, failures: 0 },\r\n      },\r\n      recentActivity: [],\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Clean up old audit logs (older than 90 days)\r\n */\r\nexport async function cleanupOldAuditLogs(): Promise<number> {\r\n  try {\r\n    const ninetyDaysAgo = new Date()\r\n    ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90)\r\n\r\n    const { data, error } = await supabase\r\n      .from('credential_audit_log')\r\n      .delete()\r\n      .lt('created_at', ninetyDaysAgo.toISOString())\r\n      .select('id')\r\n\r\n    if (error) throw error\r\n\r\n    return data?.length || 0\r\n  } catch (error) {\r\n    console.error('Error cleaning up audit logs:', error)\r\n    return 0\r\n  }\r\n}\r\n\r\n// ============================================\r\n// WORKSPACE-SPECIFIC AUDIT LOGGING\r\n// ============================================\r\n\r\nexport type WorkspaceAuditAction =\r\n  | 'member_invited'        // When someone sends an invite\r\n  | 'member_joined'         // When someone accepts invite\r\n  | 'member_removed'        // When admin removes a member\r\n  | 'member_role_changed'   // When admin changes member's role\r\n  | 'workspace_updated'     // When workspace settings change\r\n  | 'invite_revoked'        // When admin cancels an invite\r\n\r\nexport interface WorkspaceAuditLogParams {\r\n  workspaceId: string\r\n  userId: string\r\n  action: WorkspaceAuditAction\r\n  entityType: string\r\n  entityId: string\r\n  details: Record<string, any>\r\n}\r\n\r\n/**\r\n * Log workspace-related actions for audit trail\r\n * Used for: member invitations, role changes, removals, etc.\r\n *\r\n * @param params - Audit log parameters\r\n * @throws Errors are logged but not thrown to prevent breaking operations\r\n */\r\nexport async function logWorkspaceAction({\r\n  workspaceId,\r\n  userId,\r\n  action,\r\n  entityType,\r\n  entityId,\r\n  details,\r\n}: WorkspaceAuditLogParams): Promise<void> {\r\n  try {\r\n    const { error } = await (supabase.from('audit_logs') as any).insert({\r\n      workspace_id: workspaceId,\r\n      user_id: userId,\r\n      action,\r\n      entity_type: entityType,\r\n      entity_id: entityId,\r\n      details,\r\n      created_at: new Date().toISOString(),\r\n    })\r\n\r\n    if (error) {\r\n      console.error(`Failed to log workspace action \"${action}\":`, error)\r\n    }\r\n  } catch (error) {\r\n    console.error('Workspace audit logging error:', error)\r\n    // Don't throw - logging failures shouldn't break the app\r\n  }\r\n}\r\n\r\n/**\r\n * Get workspace activity log with filters\r\n *\r\n * @param workspaceId - Workspace to get activity for\r\n * @param filters - Optional filters for activity type, user, date range\r\n * @returns Paginated activity logs with total count\r\n */\r\nexport async function getWorkspaceActivityLog(\r\n  workspaceId: string,\r\n  filters?: {\r\n    userId?: string\r\n    action?: WorkspaceAuditAction\r\n    startDate?: Date\r\n    endDate?: Date\r\n    limit?: number\r\n    offset?: number\r\n  }\r\n): Promise<{\r\n  data: any[]\r\n  total: number\r\n  limit: number\r\n  offset: number\r\n  hasMore: boolean\r\n}> {\r\n  try {\r\n    // Build the query\r\n    let query = supabase\r\n      .from('audit_logs')\r\n      .select(\r\n        `\r\n        id,\r\n        workspace_id,\r\n        user_id,\r\n        action,\r\n        entity_type,\r\n        entity_id,\r\n        details,\r\n        created_at,\r\n        users:user_id (\r\n          email,\r\n          full_name\r\n        )\r\n      `,\r\n        { count: 'exact' }\r\n      )\r\n      .eq('workspace_id', workspaceId)\r\n      .order('created_at', { ascending: false })\r\n\r\n    // Apply filters\r\n    if (filters?.userId) {\r\n      query = query.eq('user_id', filters.userId)\r\n    }\r\n\r\n    if (filters?.action) {\r\n      query = query.eq('action', filters.action)\r\n    }\r\n\r\n    if (filters?.startDate) {\r\n      query = query.gte('created_at', filters.startDate.toISOString())\r\n    }\r\n\r\n    if (filters?.endDate) {\r\n      query = query.lte('created_at', filters.endDate.toISOString())\r\n    }\r\n\r\n    // Pagination\r\n    const limit = Math.min(filters?.limit || 50, 500) // Cap at 500\r\n    const offset = filters?.offset || 0\r\n    query = query.range(offset, offset + limit - 1)\r\n\r\n    const { data, error, count } = await query\r\n\r\n    if (error) {\r\n      console.error('Error fetching workspace activity log:', error)\r\n      throw error\r\n    }\r\n\r\n    return {\r\n      data: data || [],\r\n      total: count || 0,\r\n      limit,\r\n      offset,\r\n      hasMore: (count || 0) > offset + limit,\r\n    }\r\n  } catch (error) {\r\n    console.error('Error getting workspace activity log:', error)\r\n    return {\r\n      data: [],\r\n      total: 0,\r\n      limit: filters?.limit || 50,\r\n      offset: filters?.offset || 0,\r\n      hasMore: false,\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 463, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/services/database/workspaceService.ts"],"sourcesContent":["/**\r\n * Workspace Service\r\n * Handles all database operations related to workspace management\r\n * Includes: workspace CRUD, member management, capacity checks\r\n */\r\n\r\nimport { createServerClient } from '@/lib/supabase/server'\r\nimport type { Workspace, UpdateWorkspaceInput, WorkspaceMember } from '@/types/workspace'\r\nimport { logWorkspaceAction } from './auditLogService'\r\n\r\n/**\r\n * Workspace Service - Static methods for workspace operations\r\n * All methods use server-side Supabase client for security\r\n */\r\nexport class WorkspaceService {\r\n  /**\r\n   * Get workspace by ID\r\n   * Retrieves complete workspace information\r\n   *\r\n   * @param workspaceId - The workspace ID to fetch\r\n   * @returns Workspace object or null if not found\r\n   * @throws Logs error but doesn't throw\r\n   */\r\n  static async getWorkspace(workspaceId: string): Promise<Workspace | null> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      const { data, error } = await supabase\r\n        .from('workspaces')\r\n        .select('*')\r\n        .eq('id', workspaceId)\r\n        .single()\r\n\r\n      if (error) {\r\n        if (error.code !== 'PGRST116') {\r\n          // PGRST116 is \"no rows returned\" - expected for not found\r\n          console.error('Error fetching workspace:', error)\r\n        }\r\n        return null\r\n      }\r\n\r\n      return data as Workspace\r\n    } catch (error) {\r\n      console.error('Unexpected error in getWorkspace:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update workspace settings\r\n   * Only admins can do this (enforced by RLS policy)\r\n   *\r\n   * @param workspaceId - Workspace to update\r\n   * @param updates - Fields to update (name, max_users, settings)\r\n   * @param userId - User making the change (for audit log)\r\n   * @returns Updated workspace or null if failed\r\n   * @throws Errors are caught and logged\r\n   */\r\n  static async updateWorkspace(\r\n    workspaceId: string,\r\n    updates: UpdateWorkspaceInput,\r\n    userId: string\r\n  ): Promise<Workspace | null> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      // Build update object with timestamp\r\n      const updateData: any = {\r\n        ...updates,\r\n        updated_at: new Date().toISOString(),\r\n      }\r\n\r\n      // Validate max_users if provided\r\n      if (updateData.max_users && updateData.max_users < 1) {\r\n        console.warn('Invalid max_users value:', updateData.max_users)\r\n        delete updateData.max_users // Don't update invalid value\r\n      }\r\n\r\n      // Validate name if provided\r\n      if (updateData.name && updateData.name.trim().length === 0) {\r\n        console.warn('Invalid workspace name (empty string)')\r\n        delete updateData.name\r\n      }\r\n\r\n      if (Object.keys(updateData).length === 1) {\r\n        // Only updated_at, nothing to actually update\r\n        return await this.getWorkspace(workspaceId)\r\n      }\r\n\r\n      // Update the workspace\r\n      const { data, error } = await (supabase\r\n        .from('workspaces') as any)\r\n        .update(updateData)\r\n        .eq('id', workspaceId)\r\n        .select()\r\n        .single()\r\n\r\n      if (error) {\r\n        console.error('Error updating workspace:', error)\r\n        return null\r\n      }\r\n\r\n      // Log the action\r\n      await logWorkspaceAction({\r\n        workspaceId,\r\n        userId,\r\n        action: 'workspace_updated',\r\n        entityType: 'workspace',\r\n        entityId: workspaceId,\r\n        details: updates,\r\n      })\r\n\r\n      return data as Workspace\r\n    } catch (error) {\r\n      console.error('Unexpected error in updateWorkspace:', error)\r\n      return null\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get all members in a workspace\r\n   * Includes: id, email, name, avatar, role, and join date\r\n   *\r\n   * @param workspaceId - Workspace to get members for\r\n   * @returns Array of workspace members, empty array if none or error\r\n   */\r\n  static async getWorkspaceMembers(workspaceId: string): Promise<WorkspaceMember[]> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('id, email, full_name, avatar_url, role, created_at, workspace_id')\r\n        .eq('workspace_id', workspaceId)\r\n        .order('created_at', { ascending: true }) // Oldest members first\r\n\r\n      if (error) {\r\n        console.error('Error fetching workspace members:', error)\r\n        return []\r\n      }\r\n\r\n      return data as WorkspaceMember[]\r\n    } catch (error) {\r\n      console.error('Unexpected error in getWorkspaceMembers:', error)\r\n      return []\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove a member from workspace\r\n   * This permanently deletes the user account in that workspace\r\n   * Note: Cascading deletes will remove their posts, credentials, etc.\r\n   * Only admins can do this (permission checked in API route)\r\n   *\r\n   * @param workspaceId - Current workspace\r\n   * @param userId - User to remove\r\n   * @param removedBy - Admin performing the action (for audit log)\r\n   * @returns Success boolean\r\n   */\r\n  static async removeMember(\r\n    workspaceId: string,\r\n    userId: string,\r\n    removedBy: string\r\n  ): Promise<boolean> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      // Get member info before deleting (for audit log)\r\n      const { data: member } = await supabase\r\n        .from('users')\r\n        .select('email, full_name, role')\r\n        .eq('id', userId)\r\n        .eq('workspace_id', workspaceId)\r\n        .single()\r\n\r\n      if (!member) {\r\n        console.warn('Member not found for removal:', userId)\r\n        return false\r\n      }\r\n\r\n      // Delete the user from this workspace\r\n      // Note: This cascades to delete their posts, credentials, campaigns, etc.\r\n      const { error } = await supabase\r\n        .from('users')\r\n        .delete()\r\n        .eq('id', userId)\r\n        .eq('workspace_id', workspaceId) // Extra safety check\r\n\r\n      if (error) {\r\n        console.error('Error removing member:', error)\r\n        return false\r\n      }\r\n\r\n      // Log the action\r\n      await logWorkspaceAction({\r\n        workspaceId,\r\n        userId: removedBy,\r\n        action: 'member_removed',\r\n        entityType: 'workspace_member',\r\n        entityId: userId,\r\n        details: {\r\n          removed_user_id: userId,\r\n          removed_user_email: (member as any).email,\r\n          removed_user_role: (member as any).role,\r\n        },\r\n      })\r\n\r\n      return true\r\n    } catch (error) {\r\n      console.error('Unexpected error in removeMember:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Change a member's role\r\n   * Allows admins to promote/demote members between admin, editor, and viewer roles\r\n   * Only admins can do this (permission checked in API route)\r\n   *\r\n   * @param workspaceId - Current workspace\r\n   * @param userId - User whose role to change\r\n   * @param newRole - New role to assign (admin, editor, viewer)\r\n   * @param changedBy - Admin performing the action (for audit log)\r\n   * @returns Success boolean\r\n   */\r\n  static async changeMemberRole(\r\n    workspaceId: string,\r\n    userId: string,\r\n    newRole: 'admin' | 'editor' | 'viewer',\r\n    changedBy: string\r\n  ): Promise<boolean> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      // Validate role\r\n      const validRoles = ['admin', 'editor', 'viewer']\r\n      if (!validRoles.includes(newRole)) {\r\n        console.warn('Invalid role provided:', newRole)\r\n        return false\r\n      }\r\n\r\n      // Get old role (for audit log)\r\n      const { data: member } = await supabase\r\n        .from('users')\r\n        .select('role, email')\r\n        .eq('id', userId)\r\n        .eq('workspace_id', workspaceId)\r\n        .single()\r\n\r\n      if (!member) {\r\n        console.warn('Member not found for role change:', userId)\r\n        return false\r\n      }\r\n\r\n      // Don't update if role is already the same\r\n      if ((member as any).role === newRole) {\r\n        console.info('Role already set to:', newRole)\r\n        return true // Not an error, just no-op\r\n      }\r\n\r\n      // Update the role\r\n      const { error } = await (supabase\r\n        .from('users') as any)\r\n        .update({ role: newRole })\r\n        .eq('id', userId)\r\n        .eq('workspace_id', workspaceId) // Extra safety check\r\n\r\n      if (error) {\r\n        console.error('Error changing role:', error)\r\n        return false\r\n      }\r\n\r\n      // Log the action\r\n      await logWorkspaceAction({\r\n        workspaceId,\r\n        userId: changedBy,\r\n        action: 'member_role_changed',\r\n        entityType: 'workspace_member',\r\n        entityId: userId,\r\n        details: {\r\n          target_user_id: userId,\r\n          target_user_email: (member as any).email,\r\n          old_role: (member as any).role,\r\n          new_role: newRole,\r\n        },\r\n      })\r\n\r\n      return true\r\n    } catch (error) {\r\n      console.error('Unexpected error in changeMemberRole:', error)\r\n      return false\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if workspace is at capacity\r\n   * Compares current member count to max_users setting\r\n   *\r\n   * @param workspaceId - Workspace to check\r\n   * @returns True if workspace is at or over max capacity\r\n   */\r\n  static async isWorkspaceFull(workspaceId: string): Promise<boolean> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      // Get workspace max_users setting\r\n      const { data: workspace } = await supabase\r\n        .from('workspaces')\r\n        .select('max_users')\r\n        .eq('id', workspaceId)\r\n        .single()\r\n\r\n      if (!workspace) {\r\n        console.warn('Workspace not found for capacity check:', workspaceId)\r\n        return true // Err on side of caution - don't allow join if workspace unknown\r\n      }\r\n\r\n      // Count current members\r\n      const { count, error } = await supabase\r\n        .from('users')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('workspace_id', workspaceId)\r\n\r\n      if (error) {\r\n        console.error('Error counting workspace members:', error)\r\n        return true // Err on side of caution\r\n      }\r\n\r\n      const memberCount = count ?? 0\r\n      return memberCount >= (workspace as any).max_users\r\n    } catch (error) {\r\n      console.error('Unexpected error in isWorkspaceFull:', error)\r\n      return true // Err on side of caution\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get workspace member count\r\n   * Returns the current number of members in the workspace\r\n   *\r\n   * @param workspaceId - Workspace to count members for\r\n   * @returns Number of members, 0 if error or workspace not found\r\n   */\r\n  static async getWorkspaceMemberCount(workspaceId: string): Promise<number> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      const { count, error } = await supabase\r\n        .from('users')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('workspace_id', workspaceId)\r\n\r\n      if (error) {\r\n        console.error('Error counting members:', error)\r\n        return 0\r\n      }\r\n\r\n      return count ?? 0\r\n    } catch (error) {\r\n      console.error('Unexpected error in getWorkspaceMemberCount:', error)\r\n      return 0\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get workspace member by ID\r\n   * Retrieves a single member's information\r\n   *\r\n   * @param workspaceId - Workspace to search in\r\n   * @param userId - User to find\r\n   * @returns Member object or null if not found\r\n   */\r\n  static async getWorkspaceMember(\r\n    workspaceId: string,\r\n    userId: string\r\n  ): Promise<WorkspaceMember | null> {\r\n    try {\r\n      const supabase = await createServerClient()\r\n\r\n      const { data, error } = await supabase\r\n        .from('users')\r\n        .select('id, email, full_name, avatar_url, role, created_at, workspace_id')\r\n        .eq('id', userId)\r\n        .eq('workspace_id', workspaceId)\r\n        .single()\r\n\r\n      if (error) {\r\n        if (error.code !== 'PGRST116') {\r\n          console.error('Error fetching member:', error)\r\n        }\r\n        return null\r\n      }\r\n\r\n      return data as WorkspaceMember\r\n    } catch (error) {\r\n      console.error('Unexpected error in getWorkspaceMember:', error)\r\n      return null\r\n    }\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 770, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/aamir/social_media_os/src/app/api/workspace/route.ts"],"sourcesContent":["/**\r\n * API Route: /api/workspace\r\n * Methods: GET, PATCH\r\n *\r\n * GET: Retrieve current user's workspace information\r\n * PATCH: Update workspace settings (admin only)\r\n */\r\n\r\nimport { NextRequest, NextResponse } from 'next/server'\r\nimport { createServerClient } from '@/lib/supabase/server'\r\nimport { WorkspaceService } from '@/services/database/workspaceService'\r\nimport type { UpdateWorkspaceInput } from '@/types/workspace'\r\n\r\n/**\r\n * GET /api/workspace\r\n * Retrieve current user's workspace details\r\n *\r\n * Response: { data: Workspace } or { error: string }\r\n */\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // Authenticate user\r\n    const supabase = await createServerClient()\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n    if (authError || !user) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' },\r\n        { status: 401 }\r\n      )\r\n    }\r\n\r\n    // Get user's workspace ID\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('workspace_id')\r\n      .eq('id', user.id)\r\n      .single()\r\n\r\n    if (userError || !userData || !('workspace_id' in userData)) {\r\n      return NextResponse.json(\r\n        { error: 'User profile not found' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    // Get workspace details\r\n    const workspace = await WorkspaceService.getWorkspace((userData as any).workspace_id)\r\n\r\n    if (!workspace) {\r\n      return NextResponse.json(\r\n        { error: 'Workspace not found' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    return NextResponse.json({ data: workspace })\r\n  } catch (error) {\r\n    console.error('Error in GET /api/workspace:', error)\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n\r\n/**\r\n * PATCH /api/workspace\r\n * Update workspace settings\r\n * Requires: Admin role\r\n *\r\n * Body: { name?: string, max_users?: number, settings?: object }\r\n * Response: { data: Workspace } or { error: string }\r\n */\r\nexport async function PATCH(request: NextRequest) {\r\n  try {\r\n    // Authenticate user\r\n    const supabase = await createServerClient()\r\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\r\n\r\n    if (authError || !user) {\r\n      return NextResponse.json(\r\n        { error: 'Unauthorized' },\r\n        { status: 401 }\r\n      )\r\n    }\r\n\r\n    // Get user's role and workspace\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('users')\r\n      .select('workspace_id, role')\r\n      .eq('id', user.id)\r\n      .single()\r\n\r\n    if (userError || !userData || !('workspace_id' in userData)) {\r\n      return NextResponse.json(\r\n        { error: 'User profile not found' },\r\n        { status: 404 }\r\n      )\r\n    }\r\n\r\n    // Check if user is admin\r\n    if ((userData as any).role !== 'admin') {\r\n      return NextResponse.json(\r\n        { error: 'Only workspace admins can update settings' },\r\n        { status: 403 }\r\n      )\r\n    }\r\n\r\n    // Parse request body\r\n    let updates: UpdateWorkspaceInput\r\n    try {\r\n      updates = await request.json()\r\n    } catch (error) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid JSON in request body' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Validate updates\r\n    if (updates.max_users !== undefined && updates.max_users < 1) {\r\n      return NextResponse.json(\r\n        { error: 'Maximum users must be at least 1' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    if (updates.name !== undefined && updates.name.trim().length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Workspace name cannot be empty' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Update workspace\r\n    const updatedWorkspace = await WorkspaceService.updateWorkspace(\r\n      (userData as any).workspace_id,\r\n      updates,\r\n      user.id\r\n    )\r\n\r\n    if (!updatedWorkspace) {\r\n      return NextResponse.json(\r\n        { error: 'Failed to update workspace' },\r\n        { status: 500 }\r\n      )\r\n    }\r\n\r\n    return NextResponse.json({ data: updatedWorkspace })\r\n  } catch (error) {\r\n    console.error('Error in PATCH /api/workspace:', error)\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}