module.exports=[29520,e=>{"use strict";var r=e.i(22109);async function t({workspaceId:e,userId:t,platform:a,action:o,status:s,errorMessage:n,errorCode:i,ipAddress:c,userAgent:l,requestPath:d,metadata:p}){try{let{error:u}=await r.supabase.from("credential_audit_log").insert({workspace_id:e,user_id:t,platform:a,action:o,status:s,error_message:n||null,error_code:i||null,ip_address:c||null,user_agent:l||null,request_path:d||null,metadata:p||null});u&&console.error("Failed to insert audit log:",u)}catch(e){console.error("Audit logging error:",e)}}e.s(["logAuditEvent",()=>t])},24836,(e,r,t)=>{r.exports=e.x("https",()=>require("https"))},6461,(e,r,t)=>{r.exports=e.x("zlib",()=>require("zlib"))},21517,(e,r,t)=>{r.exports=e.x("http",()=>require("http"))},92509,(e,r,t)=>{r.exports=e.x("url",()=>require("url"))},54799,(e,r,t)=>{r.exports=e.x("crypto",()=>require("crypto"))},32319,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},18622,(e,r,t)=>{r.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},70406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,r,t)=>{r.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},42315,(e,r,t)=>{"use strict";r.exports=e.r(18622)},97953,(e,r,t)=>{"use strict";r.exports=e.r(42315).vendored["react-rsc"].ReactServerDOMTurbopackServer},32676,e=>{"use strict";var r=e.i(97953);let t=(0,r.registerClientReference)(function(){throw Error("Attempted to call createBrowserClient() from the server but createBrowserClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/lib/supabase/index.ts <module evaluation>","createBrowserClient"),a=(0,r.registerClientReference)(function(){throw Error("Attempted to call supabase() from the server but supabase is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/lib/supabase/index.ts <module evaluation>","supabase");e.s(["createBrowserClient",0,t,"supabase",0,a])},26222,e=>{"use strict";var r=e.i(97953);let t=(0,r.registerClientReference)(function(){throw Error("Attempted to call createBrowserClient() from the server but createBrowserClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/lib/supabase/index.ts","createBrowserClient"),a=(0,r.registerClientReference)(function(){throw Error("Attempted to call supabase() from the server but supabase is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.")},"[project]/src/lib/supabase/index.ts","supabase");e.s(["createBrowserClient",0,t,"supabase",0,a])},22109,e=>{"use strict";e.i(32676);var r=e.i(26222);e.n(r)},56410,e=>{"use strict";var r=e.i(22109),t=e.i(54799);async function a(e){try{let r=process.env.ENCRYPTION_MASTER_KEY;if(!r)throw Error("ENCRYPTION_MASTER_KEY environment variable not set");return t.default.pbkdf2Sync(r,e,1e5,32,"sha256")}catch(e){throw console.error("Failed to get workspace encryption key:",e),Error("Encryption key unavailable")}}async function o(e,r){try{let a=JSON.stringify(e),o=t.default.randomBytes(12),s=t.default.createCipheriv("aes-256-gcm",r,o),n=s.update(a,"utf8","hex");n+=s.final("hex");let i=s.getAuthTag();return Buffer.concat([o,i,Buffer.from(n,"hex")]).toString("base64")}catch(e){throw console.error("Encryption failed:",e),Error("Failed to encrypt credentials")}}async function s(e,r){try{let a=Buffer.from(e,"base64"),o=a.slice(0,12),s=a.slice(12,28),n=a.slice(28),i=t.default.createDecipheriv("aes-256-gcm",r,o);i.setAuthTag(s);let c=i.update(n.toString("hex"),"hex","utf8");return c+=i.final("utf8"),JSON.parse(c)}catch(e){throw console.error("Decryption failed:",e),Error("Failed to decrypt credentials")}}var n=e.i(29520);class i{static async savePlatformCredentials(e,t,s,i,c={}){try{let l=await a(i),d=await o(t,l),{data:p,error:u}=await r.supabase.from("social_accounts").select("id").eq("workspace_id",i).eq("platform",e).maybeSingle();if(u)throw u;let f={credentials_encrypted:d,is_connected:t.isConnected??!0,username:t.username||null,expires_at:t.expiresAt||null,last_refreshed_at:new Date().toISOString(),refresh_token_encrypted:t.refreshToken?await o({token:t.refreshToken},l):null,page_id:c.pageId||null,page_name:c.pageName||null,connected_at:t.isConnected?new Date().toISOString():null,refresh_error_count:0};if(p){let{error:t}=await r.supabase.from("social_accounts").update(f).eq("id",p.id);if(t)throw t;await (0,n.logAuditEvent)({workspaceId:i,userId:s,platform:e,action:"credentials_updated",status:"success"})}else{let{error:t}=await r.supabase.from("social_accounts").insert({workspace_id:i,platform:e,...f});if(t)throw t;await (0,n.logAuditEvent)({workspaceId:i,userId:s,platform:e,action:"platform_connected",status:"success"})}}catch(r){throw console.error("Error saving credentials:",r),await (0,n.logAuditEvent)({workspaceId:i,userId:s,platform:e,action:"credentials_save_failed",status:"failed",errorMessage:r instanceof Error?r.message:String(r),errorCode:"SAVE_ERROR"}).catch(e=>console.error("Failed to log error:",e)),r}}static async getPlatformCredentials(e,t,o){try{let{data:t,error:n}=await r.supabase.from("social_accounts").select("*").eq("workspace_id",o).eq("platform",e).maybeSingle();if(n||!t)return null;let i=await a(o),c=await s(t.credentials_encrypted,i),l=null;if(t.refresh_token_encrypted)try{l=(await s(t.refresh_token_encrypted,i)).token}catch(e){console.error("Failed to decrypt refresh token:",e)}return{...c,refreshToken:l,expiresAt:t.expires_at,pageId:t.page_id,pageName:t.page_name,isConnected:t.is_connected}}catch(e){return console.error("Error getting credentials:",e),null}}static async verifyAndRefreshToken(e,r,t,a){try{let o=await this.getPlatformCredentials(e,r,t);if(!o)throw Error(`No credentials found for ${e}`);if(o.expiresAt){let s=new Date(o.expiresAt).getTime();if(Date.now()>s)if(a&&o.refreshToken)try{let s=await a(o);return await this.savePlatformCredentials(e,s,r,t),await (0,n.logAuditEvent)({workspaceId:t,userId:r,platform:e,action:"token_refreshed",status:"success"}),s}catch(a){throw await (0,n.logAuditEvent)({workspaceId:t,userId:r,platform:e,action:"token_refresh_failed",status:"failed",errorMessage:a instanceof Error?a.message:String(a),errorCode:"REFRESH_ERROR"}),Error(`Token refresh failed: ${a instanceof Error?a.message:String(a)}`)}else throw Error("Token expired and no refresh token available")}return o}catch(e){throw console.error("Token verification failed:",e),e}}static async disconnectPlatform(e,t,a){try{let{error:o}=await r.supabase.from("social_accounts").update({is_connected:!1,credentials_encrypted:null,refresh_token_encrypted:null,connected_at:null}).eq("workspace_id",a).eq("platform",e);if(o)throw o;await (0,n.logAuditEvent)({workspaceId:a,userId:t,platform:e,action:"platform_disconnected",status:"success"})}catch(r){throw console.error("Error disconnecting platform:",r),await (0,n.logAuditEvent)({workspaceId:a,userId:t,platform:e,action:"disconnect_failed",status:"failed",errorMessage:r instanceof Error?r.message:String(r),errorCode:"DISCONNECT_ERROR"}).catch(e=>console.error("Failed to log error:",e)),r}}static async getConnectionStatus(e){try{let{data:t,error:a}=await r.supabase.from("social_accounts").select("platform, is_connected, username, page_name, expires_at").eq("workspace_id",e);if(a)throw a;let o={twitter:{isConnected:!1},linkedin:{isConnected:!1},facebook:{isConnected:!1},instagram:{isConnected:!1}},s=Date.now();for(let e of t||[]){let r=e.expires_at?new Date(e.expires_at).getTime():null;o[e.platform]={isConnected:e.is_connected,username:e.username||e.page_name,expiresAt:e.expires_at,isExpiringSoon:r&&r-s<864e5&&r>s,isExpired:r&&r<=s}}return o}catch(e){return console.error("Error getting connection status:",e),{twitter:{isConnected:!1},linkedin:{isConnected:!1},facebook:{isConnected:!1},instagram:{isConnected:!1}}}}static async deletePlatformCredentials(e,t){try{let{error:a}=await r.supabase.from("social_accounts").delete().eq("workspace_id",t).eq("platform",e);if(a)throw a}catch(e){throw console.error("Error deleting credentials:",e),e}}static async getAllCredentialsStatus(e){try{let{data:t,error:a}=await r.supabase.from("social_accounts").select("platform, is_connected, username, page_name").eq("workspace_id",e);if(a)throw a;return(t||[]).map(e=>({platform:e.platform,isConnected:e.is_connected,username:e.username||e.page_name}))}catch(e){return console.error("Error getting all credentials status:",e),[]}}}e.s(["CredentialService",()=>i],56410)},5891,e=>{"use strict";e.i(22109),e.i(56410),e.s([],5891)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__5e75132e._.js.map